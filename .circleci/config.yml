version: 2

jobs:
  check:
    docker:
    - image: circleci/node:10.11.0
    steps:
    - run: git clone https://github.com/pokeapi/deploy --depth=1
    - run: yarn --cwd deploy/functions
    - run: yarn --cwd deploy/functions run lint
    - run: yarn --cwd deploy/functions run build

  ditto-transform:
    docker:
    - image: circleci/python:3.6.5
    steps:
    - run: git clone https://github.com/pokeapi/api-data --depth=1
    - run: pip install --user -r api-data/requirements.txt
    - run: mkdir -p workspace
    - run:
        command: |
          ~/.local/bin/ditto transform \
            --base-url='https://pokeapi-215911.firebaseapp.com' \
            --src-dir=api-data/data \
            --dest-dir=workspace/_gen
    - persist_to_workspace:
        root: workspace
        paths:
        - _gen

  firebase-deploy:
    docker:
    - image: circleci/node:10.11.0
    steps:
    - run: git clone https://github.com/pokeapi/deploy --depth=1
    - run: yarn --cwd deploy/functions
    - attach_workspace:
        at: workspace
    - run: cp -r workspace/_gen deploy/public/_gen
    - run: cd deploy && echo TODO actually deploy it

workflows:
  version: 2
  deploy:
    jobs:
    - ditto-transform
    - firebase-deploy:
        requires:
        - ditto-transform
        filters:
          branches:
            only: master
