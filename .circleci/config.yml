version: 2

jobs:
  build:
    docker:
    - image: circleci/node:10.11.0
    steps:
    - checkout
    - run: yarn --cwd functions install
    - run: yarn --cwd functions run lint
    - run: yarn --cwd functions run build

  test:
    docker:
    - image: circleci/node:10.11.0
    steps:
    - checkout
    - run: yarn --cwd functions
    # TODO: write some tests and run them here

  deploy:
    docker:
    - image: circleci/node:10.11.0
    steps:
    - checkout
    - run: wget $(curl -s 'https://circleci.com/api/v1.1/project/github/PokeAPI/api-data/latest/artifacts?branch=master' | jq -r .[0].url)
    - run: mkdir -p public && tar xzf _gen.tar.gz -C public
    - run: yarn --cwd functions install
    - run: functions/node_modules/.bin/firebase deploy --token=$FIREBASE_DEPLOY_TOKEN

workflows:
  version: 2
  workflow:
    jobs:
    - build
    - test:
        requires:
        - build
    - deploy:
        requires:
        - test
        filters:
          branches:
            only: master
